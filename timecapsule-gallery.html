<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Capsule Gallery (3D View)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #2a2a2a;
            color: white;
            overflow: hidden;
        }
        #gallery-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #canvas-3d-gallery {
            display: block;
            width: 100%;
            height: 100%;
        }
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 8px;
            text-align: left;
            z-index: 10;
        }
        #status-info {
            font-size: 14px;
            color: #00ff88;
            margin-bottom: 5px;
        }
        .back-button {
            margin-top: 10px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .info-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff88;
            z-index: 100;
            display: none;
            max-width: 300px;
            pointer-events: none; /* Ignore clicks unless visible */
        }
    </style>
</head>
<body>
    <div id="gallery-container">
        <div id="ui-overlay">
            <h2>My Time Capsule Gallery</h2>
            <div id="status-info">Total Capsules: 0. Drag to rotate.</div>
            <button class="back-button" onclick="location.href='timecapsule.html'">
                ‚Üê Back to Builder
            </button>
        </div>

        <div id="info-panel" class="info-panel">
            <h3 id="panel-name" style="color:#00ff88; margin-bottom: 5px;">Capsule Name</h3>
            <div id="panel-status" style="font-weight: bold; margin-bottom: 10px;"></div>
            <div id="panel-date" style="color: #ccc; font-size: 13px;">Open Date: --</div>
            <button id="panel-view-btn" style="
                margin-top: 15px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; pointer-events: all;
            ">
                View/Open Capsule
            </button>
        </div>
        
        <canvas id="canvas-3d-gallery"></canvas>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';

        // --- SCENE SETUP ---
        const container = document.getElementById('gallery-container');
        const canvas = document.getElementById('canvas-3d-gallery');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x330066); // Dark purple background
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

        const updateRendererSize = () => {
            renderer.setSize(container.clientWidth, container.clientHeight);
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
        };

        window.addEventListener('resize', updateRendererSize);
        updateRendererSize();

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        scene.add(directionalLight);

        // Ground Plane (matches screenshot aesthetic)
        const planeGeometry = new THREE.CylinderGeometry(200, 200, 1, 64);
        const planeMaterial = new new THREE.MeshPhongMaterial({ color: 0x663399, shininess: 50 });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.position.y = -50;
        scene.add(plane);

        camera.position.set(0, 50, 200);

        // State for Interaction
        let targetRotation = 0;
        let currentRotation = 0;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let selectedCapsule = null;
        
        // --- DATA & HELPER FUNCTIONS ---

        function getCapsuleColor(openDate) {
            const now = new Date();
            const isOpen = new Date(openDate) <= now;
            
            if (isOpen) {
                return { color: 0x44ff44, emissive: 0x008800 }; // Bright Green (Open)
            } else {
                // Determine sealed color based on time remaining (simple stages)
                const diff = new Date(openDate) - now;
                const year = 365 * 24 * 60 * 60 * 1000;
                
                if (diff < year / 4) { // Opening soon (3 months)
                    return { color: 0xffaa00, emissive: 0x995500 }; // Orange/Yellow (Soon)
                } else {
                    return { color: 0x8888aa, emissive: 0x333344 }; // Gray/Purple (Sealed)
                }
            }
        }
        
        // Custom Capsule Geometry (Mimics the simple shapes in the image)
        function createCapsule(capsuleData, index) {
            // Using Cylinder for simplicity, resembles the look in the screenshot
            const colors = getCapsuleColor(capsuleData.openDate);
            
            const geometry = new THREE.CylinderGeometry(15, 15, 60, 32);
            const material = new THREE.MeshPhongMaterial({
                color: colors.color,
                emissive: colors.emissive,
                emissiveIntensity: 0.5,
                shininess: 100
            });
            
            const capsuleMesh = new THREE.Mesh(geometry, material);

            // Positioning in a rough circle/grid
            const angle = index * (Math.PI * 2 / 10) + Math.random() * 0.5; 
            const radius = 80 + Math.random() * 20; 
            
            capsuleMesh.position.x = Math.cos(angle) * radius;
            capsuleMesh.position.z = Math.sin(angle) * radius;
            capsuleMesh.position.y = -15 + Math.random() * 5; 

            // Store capsule data in the mesh for interaction
            capsuleMesh.userData = capsuleData;
            
            scene.add(capsuleMesh);
        }

        // --- MAIN LOAD FUNCTION ---

        function renderGallery3D() {
            const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
            document.getElementById('status-info').textContent = `Total Capsules: ${capsules.length}. Drag to rotate.`;
            
            if (capsules.length === 0) {
                 const message = new THREE.Mesh(
                    new THREE.PlaneGeometry(10, 10),
                    new THREE.MeshBasicMaterial({ color: 0xffffff })
                 );
                 // Placeholder for "No Capsules" message in 3D space
                 // For now, rely on the overlay text.
                 return;
            }

            capsules.forEach((capsule, index) => {
                createCapsule(capsule, index);
            });
        }
        
        // --- INTERACTION ---

        function getMousePosition(event) {
            const rect = canvas.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        }

        function selectCapsule(capsule) {
            selectedCapsule = capsule;
            const now = new Date();
            const openDate = new Date(capsule.openDate);
            const isOpen = openDate <= now;

            document.getElementById('panel-name').textContent = capsule.name;
            document.getElementById('panel-status').textContent = isOpen ? "üîì Ready to Open" : "üîí Sealed";
            document.getElementById('panel-status').style.color = isOpen ? '#ff4444' : '#00ff88';
            document.getElementById('panel-date').textContent = `Open Date: ${openDate.toLocaleDateString()}`;
            document.getElementById('info-panel').style.display = 'block';
        }

        function deselectCapsule() {
            selectedCapsule = null;
            document.getElementById('info-panel').style.display = 'none';
        }
        
        // Mouse Down for Rotation or Selection
        canvas.addEventListener('mousedown', (e) => {
            getMousePosition(e);
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true).filter(i => i.object.userData.name !== 'ground');
            
            if (intersects.length > 0 && intersects[0].object.userData.id) {
                // Capsule selected
                selectCapsule(intersects[0].object.userData);
            } else {
                // Start rotation
                deselectCapsule();
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });

        // Mouse Move for Rotation
        canvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const deltaMove = {
                x: e.clientX - previousMousePosition.x,
                y: e.clientY - previousMousePosition.y
            };
            
            targetRotation += deltaMove.x * 0.005;
            
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        // Mouse Up to Stop Rotation
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Button to navigate to the detailed view
        document.getElementById('panel-view-btn').addEventListener('click', () => {
            if (selectedCapsule) {
                // Navigate to the complex 3D view (timecapsule-view.html)
                window.location.href = `timecapsule-view.html?id=${selectedCapsule.id}`;
            }
        });
        
        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            currentRotation += (targetRotation - currentRotation) * 0.1;
            scene.rotation.y = currentRotation;

            renderer.render(scene, camera);
        }

        renderGallery3D();
        animate();
    </script>
</body>
</html>
