<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Time Capsule Gallery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-info {
            display: flex;
            gap: 30px;
            font-size: 14px;
        }
        
        #gallery-canvas {
            width: 100vw;
            height: 100vh;
            display: block;
            cursor: pointer;
        }
        
        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 25px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            z-index: 200;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn.primary {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        
        .capsule-info-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 100px 40px 40px;
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 150;
        }
        
        .capsule-info-panel.active {
            right: 0;
        }
        
        .panel-close {
            position: absolute;
            top: 30px;
            right: 30px;
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }
        
        .capsule-detail h2 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .date-info {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 30px;
        }
        
        .countdown-display {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .countdown-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .countdown-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .detail-value {
            font-size: 16px;
            color: white;
        }
        
        .empty-state {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }
        
        .empty-state h2 {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .empty-state p {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
        }
        
        .empty-state button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .empty-state button:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>My Time Capsule Gallery</h1>
        <div class="header-info">
            <div class="info-item">
                <span style="opacity: 0.6;">Total Capsules</span>
                <strong id="total-count">0</strong>
            </div>
            <div class="info-item">
                <span style="opacity: 0.6;">Ready to Open</span>
                <strong id="ready-count" style="color: #00ff88;">0</strong>
            </div>
            <button onclick="unlockAllCapsules()" style="padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 12px; margin-left: 20px;">üîì Admin: Unlock All</button>
        </div>
    </div>

    <canvas id="gallery-canvas"></canvas>

    <div id="empty-state" class="empty-state" style="display: none;">
        <h2>No Time Capsules Yet</h2>
        <p>Create your first time capsule to start your collection</p>
        <button onclick="window.location.href='index.html'">Create Capsule</button>
    </div>

    <div class="controls">
        <button class="control-btn" id="zoom-out">‚àí Zoom Out</button>
        <button class="control-btn" id="zoom-in">+ Zoom In</button>
        <button class="control-btn" id="rotate-left">‚Üê Rotate</button>
        <button class="control-btn" id="rotate-right">Rotate ‚Üí</button>
        <button class="control-btn" id="import-json-btn" style="background: #667eea;">üì• Import JSON</button>
        <button class="control-btn primary" onclick="window.location.href='index.html'">+ New Capsule</button>
    </div>
    
    <input type="file" id="json-file-input" accept=".json" style="display: none;">


    <div class="capsule-info-panel" id="info-panel">
        <button class="panel-close" onclick="closePanel()">√ó</button>
        <div id="capsule-detail" class="capsule-detail"></div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; position: relative;">
            <button onclick="closeShareModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 30px; cursor: pointer;">√ó</button>
            
            <h2 style="color: white; margin-bottom: 20px; font-size: 28px;">Share Time Capsule</h2>
            
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <label style="color: rgba(255,255,255,0.8); font-size: 12px; display: block; margin-bottom: 8px;">Share Link</label>
                <div style="display: flex; gap: 10px;">
                    <input id="share-url" readonly style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 12px; background: white; color: #000;" value="">
                    <button onclick="copyShareLink()" style="padding: 12px 20px; background: #00ff88; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Copy</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="color: rgba(255,255,255,0.8); font-size: 14px; display: block; margin-bottom: 12px;">Share via</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button onclick="shareViaEmail()" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600;">Email</button>
                    <button onclick="shareViaTwitter()" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600;">Twitter</button>
                    <button onclick="shareViaFacebook()" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600;">Facebook</button>
                    <button onclick="shareViaWhatsApp()" style="padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600;">WhatsApp</button>
                </div>
            </div>

            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                <button onclick="downloadCapsuleJSON()" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600;">Download as JSON File</button>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { SVGLoader } from 'three/addons/loaders/SVGLoader.js';

        const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
        console.log('Loaded capsules:', capsules);

        document.getElementById('total-count').textContent = capsules.length;
        
        const now = new Date();
        const readyCount = capsules.filter(c => new Date(c.openDate) <= now).length;
        document.getElementById('ready-count').textContent = readyCount;

        if (capsules.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
        }

        // SVG Shape Data - ALL SHAPES
        const allSvgPaths = [
            { id: 1, viewBox: "0 0 120.29 776.67", path: "M58.61,6.74c8.05,7.09,17.3,23.07,20.5,40.22,1.99,9.63,1.77,22.69-2.45,28.51-3.77,5.36-8,5.1-13.41,8.21-10.95,5.19-21.63,26.6-27.59,47.98-3.49,11.94-6.69,23.89-8.65,40.49-3.35,26.91-1.32,60.97,5.77,84.58,17.15,58.2,48.07,53.43,67.98,90.05,8.87,16.21,17.65,44.78,12.44,72.5-4.75,29.19-22.12,41.67-21.96,75.47.04,20.01,5.73,38.68,10.19,55.34,7.97,28.28,14.31,60.57,17.25,93.73,3.32,33.16,1.83,66.22-7.44,92.11-7.61,22.29-18.57,40.78-31.03,40.76-21.79.54-41-45.05-43-95.42-2.5-40.5,2.74-81.86.79-122.49-2.27-49.21-17.85-88.33-22.25-136.52-2.36-22.07-2.58-45.03-1.33-67.54,2.17-34.47,3.97-65.2-2.44-98.14C1.24,202.71-6.87,168.93,8.54,113.28c3.73-13.56,6.68-27.87,7.39-44.13,1.08-19.91,1.74-43.81,9.22-56.66C34.02-3.23,48.02-2.82,58.41,6.56l.19.17Z" },
            { id: 2, viewBox: "0 0 192.44 631.71", path: "M118.87,12.14c13.81-16.31,33.01-3.54,41.48,20.21,20.36,57.22-12.86,145.95-12.96,213.31-.25,11.48.21,22.89,1.52,34,3.5,29.97,12.72,55.83,21.46,81.8,14.67,41.86,29.34,91.95,18.08,142.1-7.76,37.47-30.12,55.37-43.14,16.41-4.18-13-5.59-28.76-5.59-43.76,1.09-51.13,9.31-90.7-14.19-130.15-15.06-26.51-39.45-32.76-57.36-17.78-19.68,15.12-33.87,49.35-30.58,84.81,1.62,18.85,8.62,36.38,16.83,48.88,8.28,13.15,18.14,23.95,23.15,42.33,6.32,23.74,5.66,55.6,16.43,76.52,3.01,6.39,6.92,11.72,10.62,16.48,3.62,5.31,9.44,10.61,9.37,18.44-1.09,9.93-10.07,13.14-16.82,15.04-18.87,4.19-39.71-5.99-55.83-24.22C-2.82,557.45-8.7,450.45,10.06,366.55c6.16-29.62,15.97-57.13,27.51-80.37,5.46-11.29,11.4-22.48,16.32-33.72,16.27-34.42,17.92-78.71,6.46-118.93-10.71-39.89-35.18-56.79-41.82-95.88-2.06-13.13.07-29.24,6.97-35.58,18.14-12.23,24.16,32.83,37.62,50,5.28,7.38,11.98,11.57,18.63,10.3,17.46-2.85,23.97-34.82,36.97-50.07l.15-.17Z" },
            { id: 3, viewBox: "0 0 199.85 661.11", path: "M86.86,169.39c24.94,61.78,107.84,157.99,95.51,246.42-9.31,54.67-42.28,75.3-67.75,95.49-15.89,12.35-31.78,17.38-48.39,12.26-11.72-3.23-23.38-8.23-35.18-2.71-12.65,5.5-24.55,22.1-28.89,46-7.34,39.05,4.49,94.18,28.29,94.27,17.34.23,31.95-22.41,45.32-41.4,9.2-13.32,18.41-26.52,27.99-38.8,8.06-10.37,16.38-19.95,25-28.52,15.65-15.87,33.01-28.02,46.65-48.92,27.42-40.35,29.81-115.68,16.82-172.92-18.11-78.77-44.02-100.45-41.4-199.18-.21-32.59,7.11-113.4-10.54-129.24-10.59-7.62-19.76,6.88-29.83,16.89-5.63,6.08-11.49,11.32-17.39,16.31-40.1,30.19-28.13,82.9-6.31,133.8l.11.25Z" },
            { id: 4, viewBox: "0 0 231.78 656.84", path: "M133.06,533.76c-21.6,42.89,5.94,77.01-5.09,110.55-10.59,25.75-33.77,6.42-44.75-9.79-40.84-55.25,7.39-127.87,36.23-187.91,6.1-15.45,9.58-31.3,11.65-48.34,6.01-45.63-6.33-54.33-17.38-90.97-12.97-44.93,20.67-71.22,22.55-111.59.56-15.95-4.68-32.33-13.24-41.55-27.65-28.87-66.16,31.18-68.25,71.73-1.67,43.22,38.49,70.76,32.1,113.65-2.25,13-9.75,22.89-18.18,26.48-25.1,10.58-52.07-30.63-57.75-66.44-3.39-20,.53-40.61-.42-60.83-.93-25.23-12.09-47.8-10.33-73.28C4.22,115.89,40.97,56.26,69.37,32.64,100.56,6.16,138.87-9.76,173.81,6.67c37.43,18.17,65.71,82.31,56.07,141.54-4.94,31.15-20.54,58.48-23.77,90.04-4.11,44.06,27.02,90.63,7.57,132.51-7.31,16.19-19.84,25.87-30.65,35.48-30.05,25.82-16.89,55.86-29.92,91.65-5.3,13.34-13.79,23.18-19.92,35.62l-.12.25Z" },
            { id: 5, viewBox: "0 0 155.99 501.32", path: "M52.1,141.33c-7.39,17.69,11.13,47.22,6.93,71.8-2.45,24.67-27.03,42.6-20.94,65.47,8.6,25.9,37.72,36.09,52.25,57.27,9.12,11.78,14.67,28.68,20.46,44.93,4.38,12.33,9.6,23.28,15.47,33.8,6.48,12.09,13.82,25.21,14.77,42.03.84,17.98-6.41,32.1-16.95,39.3-21.13,13.29-50.63.95-66.43-25.62-5.62-9.61-9.29-22.21-10-35.65-1.61-30.03,8.04-54.96-10.47-73.5-9-9.83-20.33-16.64-27.22-31.23-7.63-16.31-6.48-39.58-8.53-59.63-1.06-16.38-3.47-28.05,2.07-39.75,5.98-12.72,18.12-21.44,18.39-39.66.2-14.16-7.69-30.01-12.72-42.06C3.66,136.01-1.11,121.39.3,105.22,4.35,67.41,32.45,35.53,52.36,18.06,64.07,8.22,76.7,1.9,89.82.39c12.5-1.45,25.42,1.07,37.09,8.31,28.82,17.62,38.83,66.28,18.06,96.93-9.57,13.49-22.66,19.16-34.99,21.15-15.43,4.05-47.97-5.23-57.81,14.38l-.07.16Z" },
            { id: 6, viewBox: "0 0 115.61 639.26", path: "M92.13,622.91c-11.79,24.58-30.04,18.55-43.28,1-9.19-11.9-17-27.66-23.62-43.7C3.29,525.91-5.52,456.11,3.51,391.46c9.11-68.92,37.33-90.26,50.06-149.17,8.39-37.75,3.1-77.5.46-115.88-1.08-18.22-1.06-36.71.71-54.81C57.67,41.33,67.33-.43,88.07,0c14.88,1.51,24.14,29.64,26.36,52.93,3.82,35.93-2.35,74.83-8.69,109.21-2.31,12.81-4.38,25.78-5.57,39.01-2.07,22.06-1.67,44.23-1.2,66.6.66,25.05-.66,50.36-1.55,75.31-1,27.75-.37,55.46,1.85,82.99,3.66,46.21,9.45,92.86,5.61,139.63-1.39,19.95-5.09,42.11-12.69,57.11l-.05.11Z" },
            { id: 7, viewBox: "0 0 123.44 596.69", path: "M117.61,525.87c9.21,15.17,6.75,35.08-2.05,48.97-12.71,20.05-31,10.17-46.28,12.56-13.31,2.08-34.36,26.67-37.15-13.83-.91-13.22,4.06-27.85,3.33-40.9-1.55-27.66-14.18-35.9-9.44-82.34,7.4-72.4,54.31-102.36,47-199.42-1.06-14.09-7.62-32.65-7.48-44.14.15-12.92,19.1-60.78,2.52-68.19-25.87-11.55-44.68,99.66-62.68,65.98-16.65-31.16,9.95-78.43,18.8-106.54C34.01,66.78,42.34,8.17,66.75,1.21c39.15-11.16,54.61,56.96,42.89,116.93-4.33,22.16-19.34,45.05-19.77,70.19-.40,23.26,16.36,46.16,19.36,64.36,7.53,45.66-19.56,87.32-29.29,126.34-6.22,24.92-12.91,73.1-6.09,98.17,8.25,30.31,33.38,31.57,43.76,48.67Z" },
            { id: 8, viewBox: "0 0 316.2 570.55", path: "M35.31,178.31c14.68-25.61,41.64-23.49,55.15,3.47,16.55,30.11,11.57,80.01,27.77,108.35,13.3,21.27,34.63,1.79,49.71,16.21,16.32,15.4,23,46.96,44.86,28.91,6.46-4.69,13.79-11.03,19.44-17.43,4.64-4.96,7.85-11.71,7.87-20.61.17-13.32-3.05-36.58.67-53.2,3.78-23.8,19.25-46.57,11.65-71.74-10.06-30.27-36.53-53.64-41.22-93.06-3.48-24.07,1.96-51.52,14.66-66.39,17.39-20.54,43.16-14.27,60.91,3.75,10.81,10.89,19.53,27.69,24.22,46.58,17.35,66.1-19.37,114.65-28.95,174.31-3.02,19.52-1.94,39.54,3.06,58.14,11.30,44.47,51.61,102.55,17.96,145.22-8.56,10.35-20.32,14.33-30.8,9.75-19.23-7.08-31.93-42.28-49.89-43.27-12.01.31-23.7,11.92-35.99,8.47-14.07-2.75-23.51-24.87-34.77-34.81-2.54-2.2-5.25-3.77-8.09-4.71-16.47-4.13-31.31,2.55-44.19-21.19-4.23-7.56-7.34-16.41-10.13-25.73-4.29-13.32-11.73-48.75-20.82-51.02-4.92,2.28,7.43,37.86,6.84,48.72,1.12,19.91-8.96,37.63-12.64,56.05-11.13,49.83,32.93,78.89,28.86,130.51-1.08,18.84-8.16,36.88-18.19,47.21-24.14,25.28-56.46-2.28-67.82-39.92-18.26-56.8,14.4-104.54,26.29-155.88,16.56-67.76-25.58-133.77,3.46-186.47l.12-.21Z" },
            { id: 9, viewBox: "0 0 229.96 576.01", path: "M38.4,4.48c14.14,11.45,27.51,34.74,40.76,50.77,21.41,26.66,24.83,57.13,11.82,96.61-7.69,23.41-18.61,43.86-27.69,66.2-4.76,11.8-9.43,24.99-11.03,39.17-2.74,21.9,5.87,35.57,18.17,25.93,46.81-45.33,29.72-186.04,70.75-246.85,18.38-30.77,55.68-52.22,72.27-7.58,12.33,35.54.5,79.47-19.41,97.21-19.68,19.22-45.37,22.49-60.28,54.35-11.61,24.72-13.93,58.14-18.99,88.07-1.92,14.13-7.18,46.73,3.7,44.81,14.94-7.73,24.84-48.26,35.25-68.82,7-15.06,15.76-27.75,26.31-34.07,23.4-15.25,53.29,6.57,49.63,55.65-2.71,35.19-18.43,66.14-17.95,102.62-.85,49.09,26.96,103.55,5.25,148.4-18.43,35.41-47.53,8.72-55.06-32.2-7.23-34.21.18-69.65,9.5-100.75,5.2-19.1,12.82-43.05,9.26-62.71-6.86-25.17-24.83,1.41-33.04,12.34-7.29,10.23-14.79,20.03-22.93,28.07-12.46,12.78-25.54,21.6-32.83,42.11-8.87,24.93-2.93,57.66-1.44,85.66,1.92,29.29-1.44,63.86-16.78,79.96-18.11,19.06-40.29-6.01-43.15-40.89-2.53-23.92,2.26-48.09,4.37-71.59,1.32-14.39,1.44-28.63-.51-42.21-4.84-34.14-20.89-59.79-27.97-92.41-10.25-43.02-3.32-85.95,11.7-122.25,5.66-15,12.84-32.49,12.84-50.08.21-23.77-12.47-39.8-20.61-56.64C4.13,81.01-.4,65.76.03,49.06.54,15.05,19.88-10.59,38.23,4.36l.17.12Z" },
            { id: 10, viewBox: "0 0 396.68 373.56", path: "M335.28,170.5c-57.79-21.65-37.5-46.35-54.42-77.16C255.67,47.46,123.71-12.74,33.63,2.38-3.01,8.52-10.99,37.06,16.94,51.59c55.89,29.07,152.96,4.29,215.72,36.08,52.28,26.48,57.5,84.9-29.54,87.41-24.94.72-102.55-20.02-91.23,16.86,7.62,24.82,70.27,6.3,97.61,7.65,76.59,3.76,73.66,52.9,33.57,79.7-47.31,31.62-109.45,21.71-171.63,28.16-98.31,10.2-96.28,74.59,12.94,65.16,79.17-6.84,179.58-52.39,198.83-95.76,10.72-24.15-1.17-44.02,32.53-64.71,20.68-12.7,50.83-18.95,80.93-18.91v-11.86c-20.33-.02-41.42-3.41-61.4-10.89Z" },
            { id: 11, viewBox: "0 0 225.86 239.5", path: "M220.46,83.81c6.68-9.76,6.97-18.03,1.95-28.72C196.3,5.89,130.25-10.71,79.59,6.72-12.89,38.14-27.21,163.16,49.45,220.28c11.11,8.42,23.69,12.65,37.46,12.49,28.35.56,53.95-28.86,73.17-18.11,10.38,5.62,11.33,18.48,23.25,22.47,9.85,4.12,25.79,3.28,33-5.64,11.13-13.17,2.06-32.65-8.93-43.17-17.98-18.29-45.19-14.38-67.61-22.73-35.22-13.68-64.81-48.23-76.41-84-5.78-18.06-3.58-49.44,19.77-51.67,21.37-1.57,34.16,22.18,37.12,41.37,2.58,14.07,2.37,27.81,5.48,41.43,2.98,14.04,10.72,27.14,22.22,35.92,17.44,13.46,44.75,19.02,60.62,1.71,7.08-8.12,8.26-18.79,7.14-29.63-1.58-14.33-3.9-24.35,4.67-36.77l.07-.11Z" },
            { id: 12, viewBox: "0 0 163.43 325.65", path: "M94.47,32.81c6.34,9.91,11.55,20.67,16.51,31.39,7.73,15.75,9.15,28.49,4.22,45.56-3.22,12.32-8.81,23.95-14.33,35.45-6.08,12.33-8.41,24.3-2.1,37.11,8.72,18.53,26.28,29.69,39.26,44.92,13.92,17.18,27.57,40.54,25.12,62.58-3.28,23.3-22.02,39.97-46.14,34.93-19.94-3.8-35.99-18.5-46.63-34.97-9.07-13.65-17.16-29.02-20.89-45.05-2.58-11.08-2.84-22.71-7.18-33.33-4.39-11.04-11.88-20.75-20.6-28.83-9.21-8.13-18.52-16.18-20.79-28.82-4.18-16.9,6.74-31.19,19.18-41.61,9.41-7.76,19.09-16.08,21.82-28.51,2.35-9.2,3.01-18.82,2.68-28.28.01-17.62-9.05-41.29,9-52.58,7.22-4.4,16.67-3.56,22.71,2.4,4.61,4.12,7.75,10.07,11.09,15.81,2.26,3.93,4.62,7.82,6.99,11.68l.09.14Z" },
            { id: 13, viewBox: "0 0 218 183.93", path: "M72.59,151.87c36.39,36.06,96.49,2.76,83.91-52.16-3.42-14.92-22.14-22.68-28.26-35.27-25.87-53.23,50.46-90.45,79.23-41.85,31.09,52.51-11.77,130.46-62.62,153.63C69.07,210.75-10.74,122.59,1.19,47.5,13.61-30.66,115.9-2.64,90.28,61.83c-6.33,15.93-26.83,21.96-29.95,41.04-2.72,16.63-.05,36.8,12.26,49Z" },
            { id: 14, viewBox: "0 0 292.62 221.31", path: "M289.94,118.97c8.33-8.03-4.69-12.29-13.41-15.96-7.85-2.94-15.14-7.14-21.82-12.21-19.33-14.7-34.56-35.27-51.84-52.7C185.56,19.92,163.7,5.04,138.57,1.39,85.32-6.81,14.01,21.56,1.11,78.34c-2.86,13.55-.73,28.17,12.44,33.9,11.85,5.4,28.67,1.56,34.83-10.69,3.77-6.88,5.09-15.39,6.96-23.16,6.13-35.46,37.7-57.2,72.9-59.39,10.56-.66,21.28.76,31.21,4.41,10.06,3.63,18.91,9.48,27.32,15.72,3.12,2.57,18.54,13.52,9.75,16.26-3.29,1.04-9.87.84-16.76.72-64.86-1.85-108.44,67.71-75.74,124.23,15.46,26.7,46.02,41.48,76.5,40.95,26.22-.22,50.48-12.29,70.63-28.48,18.63-15.7,5.63-29.18,12.3-47.89,4.41-13.37,16.72-17.36,26.39-25.86l.11-.10Z" },
            { id: 15, viewBox: "0 0 268.66 281.47", path: "M138.83,134.21c13.28,16.47,66.26,10.68,90.22,19.94,69.4,26.83,39.1,152.89-25.52,122.67-35-16.37-6.48-100.35-66.48-121.04-69.35-23.91-71.66,67.57-101.31,107.34-7.99,5.64-13.6,2.31-20.34-2.74-57.46-43.03,63.55-147.4,74.41-186.74,5.08-18.37-13.36-46.09,1.74-65.55L106.44,0c85.14,11.31,3.88,98.83,32.4,134.21Z" },
            { id: 16, viewBox: "0 0 351.43 239.81", path: "M194.39,15.64c-15.21,12.88-17.48,34.19-27.92,50.25-7.59,11.97-19.55,20.5-27.47,32.85-5.88,8.82-8.91,19.52-13.39,28.94-11.5,25.38-36.73,13.36-55.87,35.3-7.52,7.59-11.64,16.52-20.43,20.3-7.05,2.12-6.95-7.94-5.37-13.23,1.65-6.73,4.8-13.45,8.23-19.54,6.09-10.51,12.48-20.01,23.03-27.47,17.65-12.16,43.64-20.89,54.5-41.75,11.24-20.53,7.87-52.58-15.52-61.78-17.3-6.94-43,2.08-51.81,20.07-6.87,12.71-.7,27.12,1.75,40,1.37,7.71-.61,13.83-5.04,20.07-5.39,7.66-12.09,14.97-16.49,23.38-7.32,13.83-9.69,29.78-18.8,42.65C15,179.17,1.43,192.63.11,209.76c-1.78,21.08,19.16,34.42,38.65,28.74,20.14-4.97,34.42-25.76,50.06-36.66,11.13-8.2,25-9.82,38.45-10.32,3.76-.23,7.52-.53,11.14-1.16,13.8-2.32,24.18-8.42,37.36-5.61,13.31,2.78,25.81,12.27,39.99,9.27,15.02-2.7,28.97-14.08,44.11-18.39,14.73-4.92,30.99-2.96,45.92-6.41,10.91-2.38,20.77-10.47,17.69-22.13-2.79-12.15-15.65-21.86-22.05-32.13-4.15-6.25-3.24-12.9,3.06-16.98,8.35-5.98,25.73-9.78,36.01-18.34,12.62-9.61,14.38-25.3,4.93-38.3-7.25-10.3-18.61-18.47-29.74-24.69C291.83,2.96,264.87-2.06,237.74.76c-15.15,1.3-31.55,4.58-43.2,14.75l-.15.13Z" },
            { id: 17, viewBox: "0 0 290.43 194.6", path: "M279.64,69.11c-.7-16.06,13.69-20.56-2.3-42.06-15.22-20.47-44.28-23.5-68.08-21.06-21.8,2.24-48.92,23.33-58.14,46.89-3.36,8.58-7.16,6.44-7.16,6.44-2.72-1.29,0-8.91,0-8.91,4.94-14.77.86-30.96-13.62-41.08C102.12-10.38,59.1,4.01,35.76,25.74,9.18,50.47-9.98,95.19,5.6,130.37c4.39,9.92,20.42,28.48,30.82,31.12,25.81,6.56,39.73-12.73,55.78-11.28,15.42,1.4,41.69,31.03,60.73,38.48,22.33,8.74,42.83,9.02,61.62-7.65,8.48-7.52,15.21-24.29,23.27-30,17-12.05,39.62-8.2,50.06-34.18,8.69-21.64-7.54-32.01-8.23-47.74Z" },
            { id: 18, viewBox: "0 0 389.86 237.26", path: "M37.01,128.85c1.88-3.81,6.19-6.89,11.85-9.88,4.97-2.64,11.2-5.68,17.51-8.89,11.12-5.8,22.17-11.18,30.56-20.11,18.63-20.22,21.04-60.57.38-80.36-14.09-12.12-36.74-12.14-52.86-3.64C26.63,16.01,9.13,31.94,18.32,54.18c5,14.56,27.27,26.58,10.62,41.41-7.37,7.05-18.8,11.47-24.96,20.09-11.03,17.48,2.98,42.68,16.33,57.8,8.25,9.32,18.48,13.29,30.26,17.11,6.85,2.31,14.39,4.75,21.44,6.94,25.42,7.91,44.22,14.54,68.13.61,14.6-6.85,23.7,1.59,36.86,6.18,13.04,4.28,28.89,1.96,38.12-8.84,8.87-9.72,14.49-22.62,23.94-31.76,12.25-13.24,35.77-16.63,42.43-32.54,2.47-6.35,2.19-13.33,3.44-20.07,1.38-9.14,7.02-17.71,15.33-22.15,43.32-20.48,50.39,55.45,19.24,75.07-14.99,10.59-28.21,5.87-44.35,7.41-13.59,1.96-16.79,16.47-14.39,28.91,7.9,39.51,55.65,51.7,75.45,14.64,8.95-14.45,10.18-32.01,16.72-47.04,3.65-8.44,9.38-15.85,15.15-23.19,7.59-9.52,14.86-19.58,18.32-31.4,6.97-23.84,4.17-52.95-15.35-68.6-11.65-9.56-29.34-11.57-44.24-8.81-9.05,1.22-18.69,4.25-27.64,2.55-10.54-2.08-18.48-11.49-28.17-15.57-5.39-2.39-11.25-3.27-17.12-4.01-19.23-1.67-40.32-5.9-59.4-2.73-32.62,7.25-32.41,25.54-48.98,48.21-7.38,9.85-17.83,14.74-27.64,22.48-13.36,10.42-17,24.81-17.27,41.01-.48,7.67-1.52,16.13-8.76,19.77-13.78,6.6-63.39,1.54-54.87-18.71l.06-.11Z" },
            { id: 19, viewBox: "0 0 285.06 261.74", path: "M269.48,1.07c-24.16-7.14-26.93,23.78-26.93,23.78-9.57,59.48-55.04,120.7-118.08,127.56-39.84,4.34-86.45-25.13-115.11,19.01-29.81,45.9,16.89,94.3,65.09,90.06,64.1-5.63,119.77-80.36,150.56-131.73,9.33-15.58,21.87-46.24,52.42-89.16,20.96-29.99-7.95-39.51-7.95-39.51Z" },
            { id: 20, viewBox: "0 0 121.1 287.9", path: "M111.62,276.16c28.74-32.49-31.21-66.81-23.07-102.83,1.83-10.57,7.1-20.08,12.3-29.32,4.82-8.48,9.37-17.37,13.45-26.9,9.3-20.72,1.4-24.52.33-43.94.09-14.96,8.2-26.78,6.13-41.9C120.02,17.35,110.34-.55,95.06.01c-6.48.25-12,4.61-18,6.45-5.61,1.98-11.65,1.77-16.91,4.63-8.09,4.57-13.67,17.03-14.96,26.8-1.36,10.69,1.75,21.7,2.65,32.19,1.72,12.65-1.98,28.18-14.28,34.67-6.76,4.14-14.66,4.71-21.31,8.78C2.88,119.53-.22,132.33.01,143.61c.38,13.57,6.54,25.28,15.98,34.99,4.09,4.17,9.08,7.9,12.9,12.17,8.9,8.55,6.39,17.7,1.97,27.71-12.19,26.05,9.99,54,33.14,64.83,15.25,8.33,34.76,4.88,47.38-6.92l.23-.24Z" },
            { id: 21, viewBox: "0 0 100 100", path: "M50,5 A45,45 0 1,1 50,95 A45,45 0 1,1 50,5 Z" },
            { id: 22, viewBox: "0 0 100 100", path: "M10,10 L90,10 L90,90 L10,90 Z" },
            { id: 23, viewBox: "0 0 100 100", path: "M50,10 L90,90 L10,90 Z" },
            { id: 24, viewBox: "0 0 100 120", path: "M20,20 L80,20 L80,100 L20,100 Z M25,15 L75,15 L75,20 L25,20 Z M25,100 L75,100 L75,105 L25,105 Z" }
        ];

        const colorPalette = [
            0xff6b6b, 0x4ecdc4, 0xf093fb, 0xfeca57,
            0x48c6ef, 0x96fbc4, 0xa18cd1, 0xfa8bff,
            0xff9a56, 0xa8edea, 0xffecd2, 0x667eea
        ];

        // Three.js setup
        const canvas = document.getElementById('gallery-canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.Fog(0x000000, 10, 50);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 15);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Ground
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshStandardMaterial({
            color: 0x1a1a1a,
            roughness: 0.8,
            metalness: 0.2
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -1;
        ground.receiveShadow = true;
        scene.add(ground);

        // Function to load SVG and create 3D shape
        function createShapeFromSVG(svgData, color) {
            return new Promise((resolve) => {
                const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${svgData.viewBox}" width="512" height="512"><path d="${svgData.path}" fill="white"/></svg>`;
                const loader = new SVGLoader();
                const svgData2 = loader.parse(svgString);
                
                const group = new THREE.Group();
                const paths = svgData2.paths;
                
                for (let i = 0; i < paths.length; i++) {
                    const path = paths[i];
                    const shapes = SVGLoader.createShapes(path);
                    
                    for (let j = 0; j < shapes.length; j++) {
                        const shape = shapes[j];
                        const geometry = new THREE.ExtrudeGeometry(shape, {
                            depth: 4,
                            bevelEnabled: true,
                            bevelThickness: 0.5,
                            bevelSize: 0.5,
                            bevelSegments: 3
                        });
                        
                        const material = new THREE.MeshStandardMaterial({
                            color: color,
                            metalness: 0.5,
                            roughness: 0.5,
                            emissive: color,
                            emissiveIntensity: 0.2
                        });
                        
                        const mesh = new THREE.Mesh(geometry, material);
                        mesh.castShadow = true;
                        group.add(mesh);
                    }
                }
                
                // Center and scale
                const box = new THREE.Box3().setFromObject(group);
                const center = box.getCenter(new THREE.Vector3());
                group.position.sub(center);
                
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 1.5 / maxDim;  // ÏõêÎûòÎåÄÎ°ú
                group.scale.setScalar(scale);
                
                resolve(group);
            });
        }

        // Create capsule objects
        const capsuleObjects = [];
        const radius = capsules.length > 6 ? 10 : 8;

        async function loadCapsules() {
            for (let index = 0; index < capsules.length; index++) {
                const capsuleData = capsules[index];
                const angle = (index / capsules.length) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                const openDate = new Date(capsuleData.openDate);
                const now = new Date();
                const isLocked = openDate > now;

                const group = new THREE.Group();

                if (isLocked) {
                    // LOCKED - Simple capsule (ÏûëÍ≤å)
                    const bodyGeometry = new THREE.CylinderGeometry(0.8, 0.8, 2, 32);
                    const bodyMaterial = new THREE.MeshStandardMaterial({
                        color: 0x9b7fbf,
                        metalness: 0.7,
                        roughness: 0.3,
                        emissive: 0x6b4f8a,
                        emissiveIntensity: 0.3
                    });
                    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                    body.castShadow = true;
                    group.add(body);

                    const capGeometry = new THREE.SphereGeometry(0.8, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
                    const cap = new THREE.Mesh(capGeometry, bodyMaterial);
                    cap.position.y = 1;
                    cap.castShadow = true;
                    group.add(cap);

                    const bottomCap = new THREE.Mesh(capGeometry, bodyMaterial);
                    bottomCap.position.y = -1;
                    bottomCap.rotation.x = Math.PI;
                    bottomCap.castShadow = true;
                    group.add(bottomCap);

                    // Lock icon (ÏûëÍ≤å)
                    const lockGeometry = new THREE.TorusGeometry(0.3, 0.1, 16, 32);
                    const lockMaterial = new THREE.MeshStandardMaterial({
                        color: 0xffaa00,
                        metalness: 0.9,
                        roughness: 0.1,
                        emissive: 0xffaa00,
                        emissiveIntensity: 0.5
                    });
                    const lockRing = new THREE.Mesh(lockGeometry, lockMaterial);
                    lockRing.rotation.x = Math.PI / 2;
                    lockRing.position.y = 0;
                    group.add(lockRing);

                    const lockBodyGeometry = new THREE.BoxGeometry(0.5, 0.6, 0.3);
                    const lockBody = new THREE.Mesh(lockBodyGeometry, lockMaterial);
                    lockBody.position.y = -0.5;
                    group.add(lockBody);
                } else {
                    // READY - Load actual parts!
                    const parts = capsuleData.parts || [];
                    
                    console.log(`Loading capsule ${index}:`, capsuleData.name, 'Parts:', parts.length);
                    
                    if (parts.length === 0) {
                        // No parts - show placeholder
                        const sphereGeometry = new THREE.SphereGeometry(1, 32, 32);
                        const sphereMaterial = new THREE.MeshStandardMaterial({
                            color: 0x00ff88,
                            metalness: 0.5,
                            roughness: 0.5,
                            emissive: 0x00ff88,
                            emissiveIntensity: 0.3
                        });
                        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                        sphere.castShadow = true;
                        group.add(sphere);
                        console.log('Added placeholder sphere');
                    } else {
                        for (let i = 0; i < parts.length; i++) {
                            const part = parts[i];
                            const svgData = allSvgPaths.find(svg => svg.id === part.svgId);
                            
                            console.log(`  Part ${i}:`, part.svgId, svgData ? 'Found' : 'NOT FOUND');
                            
                            if (svgData) {
                                try {
                                    const color = colorPalette[i % colorPalette.length];
                                    const partMesh = await createShapeFromSVG(svgData, color);
                                    
                                    // Apply saved transformations (ÏõêÎûòÎåÄÎ°ú)
                                    if (part.position) {
                                        partMesh.position.set(
                                            part.position.x * 0.02,
                                            part.position.y * 0.02,
                                            part.position.z * 0.02
                                        );
                                    }
                                    if (part.rotation) {
                                        partMesh.rotation.set(
                                            part.rotation.x,
                                            part.rotation.y,
                                            part.rotation.z
                                        );
                                    }
                                    if (part.scale) {
                                        partMesh.scale.multiplyScalar(part.scale.x * 0.3);
                                    }
                                    
                                    group.add(partMesh);
                                    console.log(`    Added part ${i} successfully`);
                                } catch (error) {
                                    console.error(`    Failed to load part ${i}:`, error);
                                }
                            }
                        }
                    }
                }

                group.position.set(x, 1, z);
                group.userData.capsuleData = capsuleData;
                group.userData.index = index;
                group.userData.isLocked = isLocked;
                
                // Set initial scale based on locked status
                if (isLocked) {
                    group.scale.setScalar(0.6);  // Locked Ï∫°ÏäêÏùÄ ÏûëÍ≤å
                } else {
                    group.scale.setScalar(2.0);  // Ready Ï∫°ÏäêÏùÄ ÌÅ¨Í≤å
                }
                
                scene.add(group);
                capsuleObjects.push(group);

                group.userData.floatOffset = Math.random() * Math.PI * 2;
            }
        }

        loadCapsules();

        // Raycaster for selection
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        canvas.addEventListener('click', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(capsuleObjects, true);

            if (intersects.length > 0) {
                let object = intersects[0].object;
                while (object.parent && !capsuleObjects.includes(object)) {
                    object = object.parent;
                }
                
                if (capsuleObjects.includes(object)) {
                    if (object.userData.isLocked) {
                        showLockedMessage(object.userData.capsuleData);
                    } else {
                        showCapsuleInfo(object.userData.capsuleData);
                    }
                }
            }
        });

        // Rotation controls
        let targetRotation = 0;
        let currentRotation = 0;

        // Zoom controls
        let targetZoom = 15;
        let currentZoom = 15;

        document.getElementById('zoom-in').addEventListener('click', () => {
            targetZoom = Math.max(5, targetZoom - 2);
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            targetZoom = Math.min(30, targetZoom + 2);
        });

        document.getElementById('rotate-left').addEventListener('click', () => {
            targetRotation += Math.PI / 4;
        });

        document.getElementById('rotate-right').addEventListener('click', () => {
            targetRotation -= Math.PI / 4;
        });

        // Show locked capsule message
        function showLockedMessage(capsuleData) {
            const panel = document.getElementById('info-panel');
            const detail = document.getElementById('capsule-detail');

            const openDate = new Date(capsuleData.openDate);
            const createdDate = new Date(capsuleData.createdDate);
            const now = new Date();

            const diff = openDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const months = Math.floor((days % 365) / 30);
            const finalDays = (days % 365) % 30;

            let countdown = '';
            if (years > 0) countdown += `${years} year${years > 1 ? 's' : ''} `;
            if (months > 0) countdown += `${months} month${months > 1 ? 's' : ''} `;
            countdown += `${finalDays} day${finalDays !== 1 ? 's' : ''}`;

            detail.innerHTML = `
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
                    <h2>${capsuleData.name}</h2>
                    <div class="date-info">Created ${createdDate.toLocaleDateString()}</div>
                </div>

                <div class="countdown-display" style="border-color: #ffaa00; background: rgba(255, 170, 0, 0.1);">
                    <div class="countdown-label" style="color: #ffaa00;">Locked Until</div>
                    <div class="countdown-value" style="color: #ffaa00;">${countdown}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Open Date</div>
                    <div class="detail-value">${openDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                </div>

                <div style="background: rgba(255, 170, 0, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 170, 0, 0.3); margin-top: 30px;">
                    <div style="font-size: 14px; color: rgba(255, 255, 255, 0.8); line-height: 1.6; text-align: center;">
                        This time capsule is still sealed.<br>
                        Come back on the open date to view its contents!
                    </div>
                </div>

                <button class="delete-capsule-btn control-btn" style="width: 100%; margin-top: 20px; background: #ff4444; border: none; padding: 15px;" data-capsule-name="${capsuleData.name}">
                    Delete Capsule
                </button>
            `;

            panel.classList.add('active');
        }

        // Show capsule info panel
        function showCapsuleInfo(capsuleData) {
            const panel = document.getElementById('info-panel');
            const detail = document.getElementById('capsule-detail');

            const openDate = new Date(capsuleData.openDate);
            const createdDate = new Date(capsuleData.createdDate);

            detail.innerHTML = `
                <h2>${capsuleData.name}</h2>
                <div class="date-info">Created ${createdDate.toLocaleDateString()}</div>

                <div class="countdown-display" style="border-color: #00ff88;">
                    <div class="countdown-label">Ready to Open!</div>
                    <div class="countdown-value">Ready</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Open Date</div>
                    <div class="detail-value">${openDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Total Parts</div>
                    <div class="detail-value">${capsuleData.parts.length} piece${capsuleData.parts.length !== 1 ? 's' : ''}</div>
                </div>

                ${capsuleData.futureMessage ? `
                    <div class="detail-section">
                        <div class="detail-label">Message to Future Self</div>
                        <div class="detail-value">${capsuleData.futureMessage}</div>
                    </div>
                ` : ''}

                <button class="open-capsule-btn control-btn primary" style="width: 100%; margin-top: 20px;" data-capsule-name="${capsuleData.name}">
                    Open Capsule
                </button>
                <button class="share-capsule-btn control-btn" style="width: 100%; margin-top: 10px; background: #00ff88; color: #000; border: none; padding: 15px;" data-capsule-name="${capsuleData.name}">
                    Share Capsule
                </button>
                <button class="delete-capsule-btn control-btn" style="width: 100%; margin-top: 10px; background: #ff4444; border: none; padding: 15px;" data-capsule-name="${capsuleData.name}">
                    Delete Capsule
                </button>
            `;

            panel.classList.add('active');
        }

        window.closePanel = function() {
            document.getElementById('info-panel').classList.remove('active');
        };

        // Admin Mode: Unlock all capsules
        window.unlockAllCapsules = function() {
            if (confirm('Admin Mode: Unlock all capsules immediately?\n\nThis will change all openDate to today.')) {
                let capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
                
                capsules.forEach(c => {
                    c.openDate = new Date().toISOString();
                });
                
                localStorage.setItem('timeCapsules', JSON.stringify(capsules));
                
                alert('All capsules unlocked! Reloading...');
                location.reload();
            }
        };

        // Import JSON functionality
        document.getElementById('import-json-btn').addEventListener('click', () => {
            const choice = confirm('Import Capsule:\n\nOK = Select JSON file\nCancel = Paste JSON text');
            
            if (choice) {
                // Select file
                document.getElementById('json-file-input').click();
            } else {
                // Paste text
                const jsonText = prompt('Paste the JSON capsule data here:');
                if (!jsonText) return;
                
                try {
                    const importedCapsule = JSON.parse(jsonText);
                    importCapsule(importedCapsule);
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Invalid JSON format! Please check the data and try again.');
                }
            }
        });

        function importCapsule(importedCapsule) {
            // Validate capsule structure
            if (!importedCapsule.name || !importedCapsule.openDate) {
                alert('‚ùå Invalid capsule format!');
                return;
            }

            const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
            
            // Check if already exists
            if (capsules.find(c => c.name === importedCapsule.name)) {
                if (!confirm(`A capsule named "${importedCapsule.name}" already exists. Replace it?`)) {
                    return;
                }
                // Remove old one
                const index = capsules.findIndex(c => c.name === importedCapsule.name);
                capsules.splice(index, 1);
            }

            capsules.push(importedCapsule);
            localStorage.setItem('timeCapsules', JSON.stringify(capsules));
            
            alert(`‚úÖ Time capsule "${importedCapsule.name}" imported successfully!`);
            location.reload();
        }

        document.getElementById('json-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedCapsule = JSON.parse(event.target.result);
                    importCapsule(importedCapsule);
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Failed to import capsule. Please check the file format.');
                }
            };
            reader.readAsText(file);
            
            // Reset input
            e.target.value = '';
        });


        window.openCapsule = function(name) {
            const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
            const capsule = capsules.find(c => c.name === name);
            
            if (!capsule) {
                alert('Capsule not found!');
                return;
            }
            
            // Create ZIP file
            const zip = new JSZip();
            
            // Add capsule info
            const infoText = `Time Capsule: ${capsule.name}
Created: ${new Date(capsule.createdDate).toLocaleDateString()}
Opened: ${new Date().toLocaleDateString()}
Message to Future Self: ${capsule.futureMessage || 'None'}

Total Parts: ${capsule.parts.length}
`;
            zip.file('capsule-info.txt', infoText);
            
            // Add each part's content
            capsule.parts.forEach((part, index) => {
                if (part.contentData) {
                    const contentData = part.contentData;
                    
                    if (contentData.type === 'text') {
                        zip.file(`part-${index + 1}-text.txt`, contentData.content || 'Empty');
                    } else if (contentData.type === 'image') {
                        const base64Data = contentData.content.split(',')[1];
                        zip.file(`part-${index + 1}-image.png`, base64Data, {base64: true});
                    } else if (contentData.type === 'drawing') {
                        const base64Data = contentData.content.split(',')[1];
                        zip.file(`part-${index + 1}-drawing.png`, base64Data, {base64: true});
                    }
                }
            });
            
            // Generate and download ZIP
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${capsule.name.replace(/[^a-z0-9]/gi, '_')}-${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`Time Capsule "${name}" opened!\n\nYour memories have been downloaded as a ZIP file.`);
            });
        };

        window.deleteCapsule = function(name) {
            console.log('deleteCapsule called for:', name);
            
            const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
            const filteredCapsules = capsules.filter(c => c.name !== name);
            localStorage.setItem('timeCapsules', JSON.stringify(filteredCapsules));

            closePanel();
            location.reload();
        };

        // Share functionality
        let currentShareCapsule = null;

        window.shareCapsule = async function(name) {
            const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
            const capsule = capsules.find(c => c.name === name);
            
            if (!capsule) {
                alert('Capsule not found!');
                return;
            }

            currentShareCapsule = capsule;

            // Encode capsule data to base64 for URL
            const capsuleJSON = JSON.stringify(capsule);
            const base64Data = btoa(unescape(encodeURIComponent(capsuleJSON)));
            
            // Create share URL
            const longURL = `${window.location.origin}${window.location.pathname}?shared=${base64Data}`;
            
            // Show modal with loading state
            document.getElementById('share-url').value = 'Generating short link...';
            document.getElementById('share-modal').style.display = 'flex';
            
            // Try to shorten URL with is.gd (CORS-friendly)
            try {
                const response = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(longURL)}`);
                const shortURL = await response.text();
                
                if (shortURL && shortURL.startsWith('http') && !shortURL.includes('Error')) {
                    document.getElementById('share-url').value = shortURL;
                } else {
                    // Fallback: just use long URL
                    document.getElementById('share-url').value = longURL;
                }
            } catch (error) {
                console.error('Failed to shorten URL:', error);
                document.getElementById('share-url').value = longURL;
            }
        };

        window.closeShareModal = function() {
            document.getElementById('share-modal').style.display = 'none';
        };

        window.copyShareLink = function() {
            const urlInput = document.getElementById('share-url');
            urlInput.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        };

        window.shareViaEmail = function() {
            const capsuleJSON = JSON.stringify(currentShareCapsule);
            
            // Always download JSON file
            const dataStr = JSON.stringify(currentShareCapsule, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentShareCapsule.name.replace(/[^a-z0-9]/gi, '_')}_capsule.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Copy JSON to clipboard
            let clipboardSuccess = false;
            navigator.clipboard.writeText(capsuleJSON).then(() => {
                clipboardSuccess = true;
            }).catch(err => {
                console.log('Clipboard failed:', err);
            });
            
            // Open email with simple instructions
            setTimeout(() => {
                const subject = encodeURIComponent(`Time Capsule: ${currentShareCapsule.name}`);
                const body = encodeURIComponent(
                    `I've created a time capsule for you!\n\n` +
                    `üìé ATTACHMENT: Please attach the downloaded JSON file to this email.\n\n` +
                    `üìã OR: The capsule data is copied to my clipboard - I'll paste it below:\n\n` +
                    `[Paste capsule data here]\n\n` +
                    `---\n` +
                    `To open:\n` +
                    `1. Go to: ${window.location.origin}${window.location.pathname}\n` +
                    `2. Click "üì• Import JSON"\n` +
                    `3. Either select the file OR paste the data`
                );
                
                window.open(`mailto:?subject=${subject}&body=${body}`);
                
                if (clipboardSuccess) {
                    alert('‚úÖ Success!\n\n1. JSON file downloaded\n2. Data copied to clipboard\n\nNow:\n‚Ä¢ Attach the file to email, OR\n‚Ä¢ Paste (Ctrl+V) the data in email body');
                } else {
                    alert('‚úÖ JSON file downloaded!\n\nPlease attach the file to your email.\n\n(Note: Clipboard copy failed - file attachment is required)');
                }
            }, 300);
        };

        window.shareViaTwitter = function() {
            const url = document.getElementById('share-url').value;
            const text = encodeURIComponent(`Check out my Time Capsule: ${currentShareCapsule.name}`);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`);
        };

        window.shareViaFacebook = function() {
            const url = document.getElementById('share-url').value;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`);
        };

        window.shareViaWhatsApp = function() {
            const url = document.getElementById('share-url').value;
            const text = encodeURIComponent(`Check out my Time Capsule: ${currentShareCapsule.name}\n${url}`);
            window.open(`https://wa.me/?text=${text}`);
        };

        window.downloadCapsuleJSON = function() {
            const dataStr = JSON.stringify(currentShareCapsule, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentShareCapsule.name.replace(/[^a-z0-9]/gi, '_')}_capsule.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Capsule downloaded as JSON file!');
        };

        // Check if page loaded with shared capsule
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('shared');
            
            if (sharedData) {
                try {
                    const capsuleJSON = decodeURIComponent(escape(atob(sharedData)));
                    const sharedCapsule = JSON.parse(capsuleJSON);
                    
                    // Show import dialog
                    if (confirm(`Import shared time capsule: "${sharedCapsule.name}"?\n\nThis will add it to your collection.`)) {
                        const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
                        
                        // Check if already exists
                        if (capsules.find(c => c.name === sharedCapsule.name)) {
                            alert('A capsule with this name already exists!');
                        } else {
                            capsules.push(sharedCapsule);
                            localStorage.setItem('timeCapsules', JSON.stringify(capsules));
                            alert('Time capsule imported successfully!');
                            location.href = window.location.pathname; // Remove query params and reload
                        }
                    }
                } catch (e) {
                    console.error('Failed to import shared capsule:', e);
                    alert('Invalid share link!');
                }
            }
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;

            currentRotation += (targetRotation - currentRotation) * 0.05;
            currentZoom += (targetZoom - currentZoom) * 0.05;
            
            // Update camera position for zoom
            camera.position.z = currentZoom;
            
            capsuleObjects.forEach((capsule, i) => {
                const floatY = Math.sin(time + capsule.userData.floatOffset) * 0.2;
                capsule.position.y = 1 + floatY;

                capsule.rotation.y = time * 0.5;

                const baseAngle = (i / capsuleObjects.length) * Math.PI * 2;
                const angle = baseAngle + currentRotation;
                capsule.position.x = Math.cos(angle) * radius;
                capsule.position.z = Math.sin(angle) * radius;

                // Í∏∞Î≥∏ Ïä§ÏºÄÏùº Ïú†ÏßÄÌïòÎ©¥ÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ÅÏö©
                const baseScale = capsule.userData.isLocked ? 0.6 : 2.0;
                const animScale = 1 + Math.sin(time * 2 + i) * 0.05;
                capsule.scale.setScalar(baseScale * animScale);
            });

            renderer.render(scene, camera);
        }

        animate();

        // Event delegation for dynamically created buttons
        document.getElementById('info-panel').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-capsule-btn')) {
                const capsuleName = e.target.getAttribute('data-capsule-name');
                if (capsuleName) {
                    deleteCapsule(capsuleName);
                }
            }
            if (e.target.classList.contains('open-capsule-btn')) {
                const capsuleName = e.target.getAttribute('data-capsule-name');
                if (capsuleName) {
                    openCapsule(capsuleName);
                }
            }
            if (e.target.classList.contains('share-capsule-btn')) {
                const capsuleName = e.target.getAttribute('data-capsule-name');
                if (capsuleName) {
                    shareCapsule(capsuleName);
                }
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
